package main

import (
    "encoding/json"
    "fmt"
    "io"
    "log"
    "net/http"
    "strings"
    "time"
)

const (
    BOT_TOKEN  = "<–í–ê–®_–¢–û–ö–ï–ù>"
    API_URL    = "http://127.0.0.1:8888/bot" + BOT_TOKEN + "/"
    WEBAPP_URL = "https://itintercom.github.io/get-ip/get-ip-v5.html"
)

type Update struct {
    UpdateID int `json:"update_id"`
    Message  *struct {
        MessageID int64  `json:"message_id"`
        Text      string `json:"text"`
        Chat      struct {
            ID int64 `json:"id"`
        } `json:"chat"`
        From struct {
            ID       int64  `json:"id"`
            Username string `json:"username"`
        } `json:"from"`
        WebAppData struct {
            Data       string `json:"data"`
            ButtonText string `json:"button_text"`
        } `json:"web_app_data"`
    } `json:"message"`
}

func postToTelegram(method, payload string) {
    url := API_URL + method
    resp, err := http.Post(url, "application/json", strings.NewReader(payload))
    if err != nil {
        log.Printf("–û—à–∏–±–∫–∞ POST: %v", err)
        return
    }
    defer resp.Body.Close()
    body, _ := io.ReadAll(resp.Body)
    log.Printf("üì§ –û—Ç–≤–µ—Ç Telegram (%s): %s", method, string(body))
}

func webhookHandler(w http.ResponseWriter, r *http.Request) {
    body, _ := io.ReadAll(r.Body)
    log.Printf("üì• RAW Update: %s", string(body))

    var upd Update
    if err := json.Unmarshal(body, &upd); err != nil {
        log.Printf("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: %v", err)
        w.WriteHeader(http.StatusBadRequest)
        return
    }

    if upd.Message == nil {
        w.WriteHeader(http.StatusOK)
        return
    }

    chatID := upd.Message.Chat.ID
    text := strings.TrimSpace(upd.Message.Text)
    data := upd.Message.WebAppData.Data

    if text == "/start" {
        urlWithVersion := fmt.Sprintf("%s?v=%d", WEBAPP_URL, time.Now().Unix())
        payload := fmt.Sprintf(`{
            "chat_id": %d,
            "text": "–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp",
            "reply_markup": {
                "inline_keyboard": [[
                    {"text": "üß™ –¢–µ—Å—Ç sendData", "web_app": {"url": "%s"}}
                ]]
            }
        }`, chatID, urlWithVersion)
        postToTelegram("sendMessage", payload)
    }

    if data != "" {
        msg := fmt.Sprintf("‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ WebApp: %s", data)
        postToTelegram("sendMessage", fmt.Sprintf(`{"chat_id":%d,"text":"%s"}`, chatID, msg))
        log.Printf("‚úÖ WebApp Data: %s", data)
    }

    w.WriteHeader(http.StatusOK)
}

func main() {
    http.HandleFunc("/webhook", webhookHandler)
    log.Println("üöÄ –¢–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ :8080/webhook")
    log.Fatal(http.ListenAndServe(":8080", nil))
}
