<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP</title>
    <script src="https://telegram.org/js/telegram-web-app.js?18"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 40px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 20px; display: none; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>

<body>
    <div id="status">‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP...</div>
    <button id="sendBtn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å IP</button>

    <script>
        (function () {
            'use strict';

            const statusDiv = document.getElementById('status');
            const sendBtn = document.getElementById('sendBtn');

            const ipServices = [
                'https://api.ipify.org?format=json',
                'https://api.my-ip.io/ip.json',
                'https://ipwho.is/?output=json',
                'https://ipapi.co/json/'
            ];

            function showError(text) {
                statusDiv.textContent = '‚ùå ' + text;
                statusDiv.className = 'error';
            }

            function showSuccess(text) {
                statusDiv.textContent = '‚úÖ ' + text;
                statusDiv.className = 'success';
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            if (typeof Telegram === 'undefined' || typeof Telegram.WebApp === 'undefined') {
                showError('–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ Telegram');
                return;
            }

            const webApp = Telegram.WebApp;
            webApp.ready();

            async function fetchIPFromService(url) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    const data = await response.json();
                    if (data.ip) return data.ip;
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
                } catch (e) {
                    clearTimeout(timeoutId);
                    throw e;
                }
            }

            async function getIP() {
                for (let i = 0; i < ipServices.length; i++) {
                    try {
                        statusDiv.textContent = `üõ∞Ô∏è ${new URL(ipServices[i]).hostname}...`;
                        const ip = await fetchIPFromService(ipServices[i]);
                        showSuccess('IP: ' + ip);
                        sendBtn.style.display = 'inline-block';
                        sendBtn.onclick = () => sendIP(ip);
                        return;
                    } catch (e) {
                        console.warn('–û—à–∏–±–∫–∞ IP:', ipServices[i], e.message);
                    }
                }
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IP');
                sendBtn.style.display = 'none';
            }

            function sendIP(ip) {
                const payload = {
                    type: 'ip_report',
                    ip,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    status: 'ok'
                };

                try {
                    Telegram.WebApp.sendData(JSON.stringify(payload));
                    showSuccess('IP –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É');
                    sendBtn.style.display = 'none';
                } catch (e) {
                    showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
                }
            }

            getIP();
        })();
    </script>
</body>

</html>
