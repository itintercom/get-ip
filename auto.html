<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>IP –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js?19"></script>
  <style>
    html, body {
      background: white;
      color: #222;
      font-family: sans-serif;
      font-size: 16px;
      text-align: center;
      padding-top: 40px;
    }

    button {
      margin-top: 20px;
      padding: 10px 16px;
      font-size: 16px;
    }

    #ip {
      font-weight: bold;
      font-size: 20px;
      margin-top: 10px;
      color: green;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div id="ip">‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP...</div>
  <button id="sendBtn" class="hidden">üì° –û—Ç–ø—Ä–∞–≤–∏—Ç—å IP</button>

  <script>
    (function () {
      const ipDisplay = document.getElementById("ip");
      const sendBtn = document.getElementById("sendBtn");

      if (!window.Telegram || !Telegram.WebApp) {
        ipDisplay.textContent = "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ Telegram";
        return;
      }

      Telegram.WebApp.ready();

      const ipSources = [
        'https://api.ipify.org?format=json',
        'https://api.my-ip.io/ip.json',
        'https://ipwho.is/?output=json',
        'https://ipapi.co/json/'
      ];

      async function fetchIP(url) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000);
        try {
          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(timeout);
          const data = await response.json();
          if (data.ip) return data.ip;
          throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç");
        } catch (e) {
          clearTimeout(timeout);
          throw e;
        }
      }

      async function detectIP() {
        for (const url of ipSources) {
          try {
            const ip = await fetchIP(url);
            ipDisplay.innerHTML = `‚úÖ IP: <span style="color:green">${ip}</span>`;
            sendBtn.classList.remove("hidden");
            sendBtn.onclick = () => sendIP(ip);
            return;
          } catch (_) {}
        }
        ipDisplay.textContent = "‚ùå IP –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å";
      }

      function sendIP(ip) {
        try {
          Telegram.WebApp.sendData(JSON.stringify({
            type: "ip_report",
            ip: ip
          }));
          ipDisplay.textContent = "‚úÖ IP –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω";
          sendBtn.classList.add("hidden");
        } catch (e) {
          ipDisplay.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message;
        }
      }

      detectIP();
    })();
  </script>
</body>

</html>
