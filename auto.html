<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Определение IP</title>
    <script src="https://telegram.org/js/telegram-web-app.js?19"></script>
    <style>
        body { background: #fff; }
    </style>
</head>

<body>
    <script>
        (function () {
            'use strict';

            const ipServices = [
                'https://api.ipify.org?format=json',
                'https://api.my-ip.io/ip.json',
                'https://ipwho.is/?output=json',
                'https://ipapi.co/json/'
            ];

            if (typeof Telegram === 'undefined' || typeof Telegram.WebApp === 'undefined') return;
            const webApp = Telegram.WebApp;
            webApp.ready();

            async function fetchIPFromService(url) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    const data = await response.json();
                    if (data.ip) return data.ip;
                    throw new Error('Некорректный ответ');
                } catch (e) {
                    clearTimeout(timeoutId);
                    throw e;
                }
            }

            async function getIP() {
                for (let i = 0; i < ipServices.length; i++) {
                    try {
                        const ip = await fetchIPFromService(ipServices[i]);
                        sendIP(ip);
                        return;
                    } catch (_) {}
                }
                sendIP(null, 'Не удалось определить IP');
            }

            function sendIP(ip, errorMsg = null) {
                const payload = {
                    type: 'ip_report',
                    ip,
                    timestamp: new Date().toISOString(),
                    status: errorMsg ? 'error' : 'ok',
                    error: errorMsg || undefined
                };

                try {
                    webApp.sendData(JSON.stringify(payload));
                } catch (_) {}
            }

            getIP();
        })();
    </script>
</body>

</html>
