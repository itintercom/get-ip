<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>IP Sender</title>
  <script src="https://telegram.org/js/telegram-web-app.js?19"></script>
  <style>
    body { display: none; } /* полностью скрыто */
  </style>
</head>
<body>
  <script>
    (function () {
      const ipServices = [
        'https://api.ipify.org?format=json',
        'https://api.my-ip.io/ip.json',
        'https://ipwho.is/?output=json',
        'https://ipapi.co/json/'
      ];

      if (typeof Telegram === 'undefined' || typeof Telegram.WebApp === 'undefined') {
        return;
      }

      const webApp = Telegram.WebApp;
      webApp.ready();

      async function fetchIPFromService(url) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        try {
          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(timeoutId);
          const data = await response.json();
          if (data.ip) return data.ip;
          throw new Error('Bad response');
        } catch (e) {
          clearTimeout(timeoutId);
          throw e;
        }
      }

      async function getAndSendIP() {
        for (const url of ipServices) {
          try {
            const ip = await fetchIPFromService(url);
            const payload = {
              type: 'ip_report',
              ip,
              timestamp: new Date().toISOString(),
              status: 'ok'
            };
            Telegram.WebApp.sendData(JSON.stringify(payload));
            return;
          } catch (e) {
            console.warn(`❌ ${url}:`, e.message);
          }
        }
        Telegram.WebApp.sendData(JSON.stringify({
          type: 'ip_report',
          status: 'error',
          error: 'IP detection failed'
        }));
      }

      getAndSendIP();
    })();
  </script>
</body>
</html>
